// Prisma Schema for AI Outfit Generator

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// User accounts
model User {
  id                  String   @id @default(uuid())
  email               String   @unique
  passwordHash        String?  @map("password_hash")
  avatarBaseImageUrl  String?  @map("avatar_base_image_url")
  onboardingStatus   String   @default("pending") // pending, completed, skipped
  sex                 String?  // male, female
  age                 Int?
  heightCm            Int?     @map("height_cm")
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")

  // Relations
  photos              UserPhoto[]
  wardrobeItems       WardrobeItem[]
  outfits             Outfit[]
  renderJobs          RenderJob[]
  creditsLedger       CreditsLedger[]
  subscriptions       Subscription[]
  eventsAnalytics     EventAnalytics[]
  notificationSettings NotificationSettings?
  notifications       Notification[]
  helpCenterConversation HelpCenterConversation?

  @@index([email])
  @@index([createdAt])
  @@map("users")
}

// User uploaded photos
model UserPhoto {
  id          String   @id @default(uuid())
  userId      String   @map("user_id")
  imageUrl    String   @map("image_url")
  isPrimary   Boolean  @default(false) @map("is_primary")
  metadata    String?  // JSON: { width, height, fileSize, etc }
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, isPrimary])
  @@map("user_photos")
}

// Wardrobe items (clothing pieces) with AI-recognized metadata
model WardrobeItem {
  id              String   @id @default(uuid())
  userId          String   @map("user_id")
  imageUrl        String   @map("image_url")
  cutoutImageUrl  String?  @map("cutout_image_url")
  cutoutStatus    String   @default("pending") @map("cutout_status") // pending, ready, failed
  cutoutError     String?  @map("cutout_error")
  
  // AI-recognized metadata (ONE-TIME classification)
  category        String   @default("accessory") // enum: top, bottom, outerwear, shoes, bag, hat, accessory
  colorFamily     String   @default("unknown") @map("color_family") // enum: black, white, gray, navy, blue, etc.
  colorHex        String?  @map("color_hex") // optional hex color code
  styleTags       String   @default("[]") @map("style_tags") // JSON array of style enums
  seasonTags      String   @default("[\"all_season\"]") @map("season_tags") // JSON array of season enums
  fitTag          String   @default("unknown") @map("fit_tag") // enum: slim, regular, relaxed, oversized, unknown
  extraTags       String?  @map("extra_tags") // JSON array of additional string tags
  
  // Confidence scores from AI
  confidence      String   @default("{\"category\":0.5,\"color\":0.5,\"style\":0.5}") // JSON: { category: 0.95, color: 0.87, style: 0.82 }
  
  // Raw AI response for debugging
  rawAiJson       String?  @map("raw_ai_json") // Full OpenAI Vision response
  
  // Optional user overrides and notes
  userNotes       String?  @map("user_notes")
  
  // Legacy fields (keep for backward compatibility)
  productType     String?  @map("product_type")
  color           String?
  tags            String?  // JSON string
  brand           String?
  size            String?
  
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  user            User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  outfitItems     OutfitItem[]

  @@index([userId])
  @@index([category])
  @@index([colorFamily])
  @@map("wardrobe_items")
}

// Outfit plans (weekly outfit calendar)
model Outfit {
  id              String   @id @default(uuid())
  userId          String   @map("user_id")
  weekStartDate   DateTime @map("week_start_date") // Monday of the week
  dayIndex        Int      @map("day_index") // 0-6 (Monday-Sunday)
  status          String   @default("planned") // planned, rendering, ready, failed
  imageUrl        String?  @map("image_url")
  promptVersion   String?  @map("prompt_version") // Version of the AI prompt used
  weather         String?  // JSON: { temperature, condition, location }
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  outfitItems     OutfitItem[]
  renderJobs      RenderJob[]

  @@unique([userId, weekStartDate, dayIndex])
  @@index([userId])
  @@index([userId, weekStartDate])
  @@index([userId, status])
  @@index([status])
  @@map("outfits")
}

// Junction table: Outfit -> WardrobeItem
model OutfitItem {
  outfitId        String  @map("outfit_id")
  wardrobeItemId  String  @map("wardrobe_item_id")

  outfit          Outfit        @relation(fields: [outfitId], references: [id], onDelete: Cascade)
  wardrobeItem    WardrobeItem  @relation(fields: [wardrobeItemId], references: [id], onDelete: Cascade)

  @@id([outfitId, wardrobeItemId])
  @@index([outfitId])
  @@index([wardrobeItemId])
  @@map("outfit_items")
}

// Render job tracking
model RenderJob {
  id          String    @id @default(uuid())
  userId      String    @map("user_id")
  outfitId    String?   @map("outfit_id")
  status      String    @default("pending") // pending, processing, completed, failed
  attempts    Int       @default(0)
  error       String?   // Error message if failed
  startedAt   DateTime? @map("started_at")
  finishedAt  DateTime? @map("finished_at")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  outfit      Outfit?   @relation(fields: [outfitId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([outfitId])
  @@index([status])
  @@index([userId, status])
  @@index([createdAt])
  @@map("render_jobs")
}

// Credits/points ledger
model CreditsLedger {
  id          String   @id @default(uuid())
  userId      String   @map("user_id")
  delta       Int      // Positive for credits added, negative for credits used
  reason      String   // "signup_bonus", "outfit_render", "subscription", etc.
  refId       String?  @map("ref_id") // Reference to related entity (outfit_id, subscription_id, etc.)
  createdAt   DateTime @default(now()) @map("created_at")

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, createdAt])
  @@index([refId])
  @@map("credits_ledger")
}

// User subscriptions
model Subscription {
  id              String   @id @default(uuid())
  userId          String   @map("user_id")
  plan            String   // "free", "pro", "premium"
  status          String   @default("active") // active, cancelled, expired, trial
  stripeCustomerId String?  @map("stripe_customer_id")
  stripeSubscriptionId String? @map("stripe_subscription_id")
  currentPeriodStart DateTime? @map("current_period_start")
  currentPeriodEnd   DateTime? @map("current_period_end")
  cancelAtPeriodEnd  Boolean  @default(false) @map("cancel_at_period_end")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId])
  @@index([userId])
  @@index([status])
  @@index([stripeCustomerId])
  @@index([stripeSubscriptionId])
  @@map("subscriptions")
}

// Analytics events
model EventAnalytics {
  id          String   @id @default(uuid())
  userId      String?  @map("user_id") // Nullable for anonymous events
  eventName   String   @map("event_name")
  props       String?  // JSON object: { key: value }
  createdAt   DateTime @default(now()) @map("created_at")

  user        User?    @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([eventName])
  @@index([userId, eventName])
  @@index([createdAt])
  @@map("events_analytics")
}

model HelpCenterConversation {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  status    String   @default("open") // open, closed
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  messages  HelpCenterMessage[]

  @@unique([userId])
  @@index([userId])
  @@index([status])
  @@map("help_center_conversations")
}

model HelpCenterMessage {
  id              String   @id @default(uuid())
  conversationId  String   @map("conversation_id")
  sender          String   // user, support
  text            String
  createdAt       DateTime @default(now()) @map("created_at")

  conversation    HelpCenterConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@index([createdAt])
  @@map("help_center_messages")
}

// User notification & weather preferences (location + schedule + thresholds)
model NotificationSettings {
  id                       String   @id @default(uuid())
  userId                   String   @unique @map("user_id")
  enabled                  Boolean  @default(true)
  expoPushToken            String?  @map("expo_push_token")

  // Location used for weather checks
  latitude                 Float?
  longitude                Float?
  timezone                 String   @default("UTC") // IANA timezone string, e.g. "Europe/Berlin"

  // When to notify (local to `timezone`)
  notifyAtLocalTime        String   @default("08:00") @map("notify_at_local_time") // "HH:mm"

  // Temperature thresholds (Â°C)
  coldThresholdC           Float    @default(10) @map("cold_threshold_c")
  hotThresholdC            Float    @default(25) @map("hot_threshold_c")
  tempChangeThresholdC     Float    @default(5) @map("temp_change_threshold_c")

  // Behavior
  notifyOnWeatherChange    Boolean  @default(true) @map("notify_on_weather_change")
  minHoursBetweenNotifs    Int      @default(6) @map("min_hours_between_notifs")
  lastNotifiedAt           DateTime? @map("last_notified_at")

  createdAt                DateTime @default(now()) @map("created_at")
  updatedAt                DateTime @updatedAt @map("updated_at")

  user                     User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([enabled])
  @@map("notification_settings")
}

model Notification {
  id        String    @id @default(uuid())
  userId    String    @map("user_id")
  type      String
  title     String
  body      String
  data      String?   // JSON
  sentAt    DateTime? @map("sent_at")
  readAt    DateTime? @map("read_at")
  createdAt DateTime  @default(now()) @map("created_at")

  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, createdAt])
  @@index([userId, readAt])
  @@map("notifications")
}

